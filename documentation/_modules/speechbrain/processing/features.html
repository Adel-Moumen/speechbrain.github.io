

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>speechbrain.processing.features &mdash; SpeechBrain 0.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> SpeechBrain
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting started:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Quick installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#install-via-pypi">Install via PyPI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#install-locally">Install locally</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#test-installation">Test Installation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../experiment.html">Running an experiment</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../experiment.html#yaml-basics">YAML basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../experiment.html#running-arguments">Running arguments</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../experiment.html#tensor-format">Tensor format</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../multigpu.html">Basics of multi-GPU</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../multigpu.html#multi-gpu-training-using-data-parallel">Multi-GPU training using Data Parallel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../multigpu.html#multi-gpu-training-using-distributed-data-parallel-ddp">Multi-GPU training using Distributed Data Parallel (DDP)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../multigpu.html#with-multiple-machines-suppose-you-have-2-servers-with-2-gpus">With multiple machines (suppose you have 2 servers with 2 GPUs):</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../contributing.html#zen-of-speechbrain">Zen of Speechbrain</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../contributing.html#how-to-get-your-code-in-speechbrain">How to get your code in SpeechBrain</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../contributing.html#python">Python</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../contributing.html#version">Version</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../contributing.html#formatting">Formatting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../contributing.html#adding-dependencies">Adding dependencies</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../contributing.html#testing">Testing</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../contributing.html#documentation">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../contributing.html#development-tools">Development tools</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../contributing.html#flake8">flake8</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../contributing.html#pre-commit">pre-commit</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../contributing.html#the-git-pre-commit-hooks">the git pre-commit hooks</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../contributing.html#the-git-pre-push-hooks">the git pre-push hooks</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../contributing.html#pytest-doctests">pytest doctests</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../contributing.html#continuous-integration">Continuous integration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../contributing.html#what-is-ci">What is CI?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../contributing.html#ci-cd-pipelines">CI / CD Pipelines</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../contributing.html#our-test-suite">Our test suite</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../contributing.html#pull-request-review-guide">Pull Request review guide</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">API Documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../speechbrain.html">Core library (speechbrain)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../speechbrain.core.html">speechbrain.core module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.core.html#summary">Summary</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.core.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../speechbrain.yaml.html">speechbrain.yaml module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../speechbrain.alignment.html">speechbrain.alignment</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.alignment.aligner.html">speechbrain.alignment.aligner module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.alignment.aligner.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.alignment.aligner.html#reference">Reference</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../speechbrain.dataio.html">speechbrain.dataio</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.dataio.batch.html">speechbrain.dataio.batch module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.dataio.batch.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.dataio.batch.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.dataio.dataio.html">speechbrain.dataio.dataio module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.dataio.dataio.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.dataio.dataio.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.dataio.dataloader.html">speechbrain.dataio.dataloader module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.dataio.dataloader.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.dataio.dataloader.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.dataio.dataset.html">speechbrain.dataio.dataset module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.dataio.dataset.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.dataio.dataset.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.dataio.encoder.html">speechbrain.dataio.encoder module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.dataio.encoder.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.dataio.encoder.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.dataio.legacy.html">speechbrain.dataio.legacy module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.dataio.legacy.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.dataio.legacy.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.dataio.sampler.html">speechbrain.dataio.sampler module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.dataio.sampler.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.dataio.sampler.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.dataio.wer.html">speechbrain.dataio.wer module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.dataio.wer.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.dataio.wer.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.dataio.html#summary">Summary</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.dataio.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../speechbrain.decoders.html">speechbrain.decoders</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.decoders.ctc.html">speechbrain.decoders.ctc module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.decoders.ctc.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.decoders.ctc.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.decoders.seq2seq.html">speechbrain.decoders.seq2seq module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.decoders.seq2seq.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.decoders.seq2seq.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.decoders.transducer.html">speechbrain.decoders.transducer module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.decoders.transducer.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.decoders.transducer.html#reference">Reference</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../speechbrain.lm.html">speechbrain.lm</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.lm.arpa.html">speechbrain.lm.arpa module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.lm.arpa.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.lm.arpa.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.lm.counting.html">speechbrain.lm.counting module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.lm.counting.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.lm.counting.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.lm.ngram.html">speechbrain.lm.ngram module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.lm.ngram.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.lm.ngram.html#reference">Reference</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../speechbrain.lobes.html">speechbrain.lobes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.lobes.augment.html">speechbrain.lobes.augment module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.lobes.augment.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.lobes.augment.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.lobes.features.html">speechbrain.lobes.features module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.lobes.features.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.lobes.features.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.lobes.models.html">speechbrain.lobes.models</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.lobes.models.CRDNN.html">speechbrain.lobes.models.CRDNN module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.lobes.models.ContextNet.html">speechbrain.lobes.models.ContextNet module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.lobes.models.ECAPA_TDNN.html">speechbrain.lobes.models.ECAPA_TDNN module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.lobes.models.ESPnetVGG.html">speechbrain.lobes.models.ESPnetVGG module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.lobes.models.MetricGAN_D.html">speechbrain.lobes.models.MetricGAN_D module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.lobes.models.RNNLM.html">speechbrain.lobes.models.RNNLM module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.lobes.models.VanillaNN.html">speechbrain.lobes.models.VanillaNN module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.lobes.models.Xvector.html">speechbrain.lobes.models.Xvector module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.lobes.models.conv_tasnet.html">speechbrain.lobes.models.conv_tasnet module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.lobes.models.convolution.html">speechbrain.lobes.models.convolution module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.lobes.models.dual_path.html">speechbrain.lobes.models.dual_path module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.lobes.models.transformer.html">speechbrain.lobes.models.transformer</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../speechbrain.nnet.html">speechbrain.nnet</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.nnet.CNN.html">speechbrain.nnet.CNN module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.nnet.CNN.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.nnet.CNN.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.nnet.RNN.html">speechbrain.nnet.RNN module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.nnet.RNN.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.nnet.RNN.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.nnet.activations.html">speechbrain.nnet.activations module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.nnet.activations.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.nnet.activations.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.nnet.attention.html">speechbrain.nnet.attention module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.nnet.attention.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.nnet.attention.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.nnet.containers.html">speechbrain.nnet.containers module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.nnet.containers.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.nnet.containers.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.nnet.dropout.html">speechbrain.nnet.dropout module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.nnet.dropout.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.nnet.dropout.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.nnet.embedding.html">speechbrain.nnet.embedding module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.nnet.embedding.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.nnet.embedding.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.nnet.linear.html">speechbrain.nnet.linear module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.nnet.linear.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.nnet.linear.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.nnet.losses.html">speechbrain.nnet.losses module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.nnet.losses.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.nnet.losses.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.nnet.normalization.html">speechbrain.nnet.normalization module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.nnet.normalization.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.nnet.normalization.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.nnet.pooling.html">speechbrain.nnet.pooling module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.nnet.pooling.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.nnet.pooling.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.nnet.schedulers.html">speechbrain.nnet.schedulers module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.nnet.schedulers.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.nnet.schedulers.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.nnet.complex_networks.html">speechbrain.nnet.complex_networks</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.nnet.complex_networks.c_CNN.html">speechbrain.nnet.complex_networks.c_CNN module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.nnet.complex_networks.c_RNN.html">speechbrain.nnet.complex_networks.c_RNN module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.nnet.complex_networks.c_linear.html">speechbrain.nnet.complex_networks.c_linear module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.nnet.complex_networks.c_normalization.html">speechbrain.nnet.complex_networks.c_normalization module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.nnet.complex_networks.c_ops.html">speechbrain.nnet.complex_networks.c_ops module</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.nnet.loss.html">speechbrain.nnet.loss</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.nnet.loss.stoi_loss.html">speechbrain.nnet.loss.stoi_loss module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.nnet.loss.transducer_loss.html">speechbrain.nnet.loss.transducer_loss module</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.nnet.quaternion_networks.html">speechbrain.nnet.quaternion_networks</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.nnet.quaternion_networks.q_CNN.html">speechbrain.nnet.quaternion_networks.q_CNN module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.nnet.quaternion_networks.q_RNN.html">speechbrain.nnet.quaternion_networks.q_RNN module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.nnet.quaternion_networks.q_linear.html">speechbrain.nnet.quaternion_networks.q_linear module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.nnet.quaternion_networks.q_normalization.html">speechbrain.nnet.quaternion_networks.q_normalization module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.nnet.quaternion_networks.q_ops.html">speechbrain.nnet.quaternion_networks.q_ops module</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.nnet.transducer.html">speechbrain.nnet.transducer</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.nnet.transducer.transducer_joint.html">speechbrain.nnet.transducer.transducer_joint module</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.nnet.html#summary">Summary</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.nnet.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../speechbrain.processing.html">speechbrain.processing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.processing.NMF.html">speechbrain.processing.NMF module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.processing.NMF.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.processing.NMF.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.processing.PLDA_LDA.html">speechbrain.processing.PLDA_LDA module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.processing.PLDA_LDA.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.processing.PLDA_LDA.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.processing.decomposition.html">speechbrain.processing.decomposition module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.processing.decomposition.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.processing.decomposition.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.processing.diarization.html">speechbrain.processing.diarization module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.processing.diarization.html#reference">Reference</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.processing.diarization.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.processing.diarization.html#id1">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.processing.features.html">speechbrain.processing.features module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.processing.features.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.processing.features.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.processing.multi_mic.html">speechbrain.processing.multi_mic module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.processing.multi_mic.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.processing.multi_mic.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.processing.signal_processing.html">speechbrain.processing.signal_processing module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.processing.signal_processing.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.processing.signal_processing.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.processing.speech_augmentation.html">speechbrain.processing.speech_augmentation module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.processing.speech_augmentation.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.processing.speech_augmentation.html#reference">Reference</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../speechbrain.tokenizers.html">speechbrain.tokenizers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.tokenizers.SentencePiece.html">speechbrain.tokenizers.SentencePiece module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.tokenizers.SentencePiece.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.tokenizers.SentencePiece.html#reference">Reference</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../speechbrain.utils.html">speechbrain.utils</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.utils.Accuracy.html">speechbrain.utils.Accuracy module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.utils.Accuracy.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.utils.Accuracy.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.utils.DER.html">speechbrain.utils.DER module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.utils.DER.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.utils.DER.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.utils.checkpoints.html">speechbrain.utils.checkpoints module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.utils.checkpoints.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.utils.checkpoints.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.utils.convert_model.html">speechbrain.utils.convert_model module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.utils.data_pipeline.html">speechbrain.utils.data_pipeline module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.utils.data_pipeline.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.utils.data_pipeline.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.utils.data_utils.html">speechbrain.utils.data_utils module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.utils.data_utils.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.utils.data_utils.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.utils.depgraph.html">speechbrain.utils.depgraph module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.utils.depgraph.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.utils.depgraph.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.utils.distributed.html">speechbrain.utils.distributed module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.utils.distributed.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.utils.distributed.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.utils.edit_distance.html">speechbrain.utils.edit_distance module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.utils.edit_distance.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.utils.edit_distance.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.utils.epoch_loop.html">speechbrain.utils.epoch_loop module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.utils.epoch_loop.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.utils.epoch_loop.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.utils.logger.html">speechbrain.utils.logger module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.utils.logger.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.utils.logger.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.utils.metric_stats.html">speechbrain.utils.metric_stats module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.utils.metric_stats.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.utils.metric_stats.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.utils.parameter_transfer.html">speechbrain.utils.parameter_transfer module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.utils.parameter_transfer.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.utils.parameter_transfer.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.utils.superpowers.html">speechbrain.utils.superpowers module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.utils.superpowers.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.utils.superpowers.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.utils.train_logger.html">speechbrain.utils.train_logger module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.utils.train_logger.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../speechbrain.utils.train_logger.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.utils.html#summary">Summary</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../speechbrain.utils.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../speechbrain.html#summary">Summary</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools.html">Runnable Tools (tools)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../tools.compute_wer.html">tools.compute_wer</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../tools.compute_wer.html#usage">Usage</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">SpeechBrain</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>speechbrain.processing.features</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for speechbrain.processing.features</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Low-level feature pipeline components</span>

<span class="sd">This library gathers functions that compute popular speech  features over</span>
<span class="sd">batches of data. All the classes are of type nn.Module. This gives the</span>
<span class="sd">possibility to have end-to-end  differentiability and to backpropagate the</span>
<span class="sd">gradient through them. Our functions are a modified version the ones</span>
<span class="sd">in torch audio toolkit (https://github.com/pytorch/audio).</span>

<span class="sd">Example</span>
<span class="sd">-------</span>
<span class="sd">&gt;&gt;&gt; import torch</span>
<span class="sd">&gt;&gt;&gt; from speechbrain.dataio.dataio import read_audio</span>
<span class="sd">&gt;&gt;&gt; signal =read_audio(&#39;samples/audio_samples/example1.wav&#39;)</span>
<span class="sd">&gt;&gt;&gt; signal = signal.unsqueeze(0)</span>
<span class="sd">&gt;&gt;&gt; compute_STFT = STFT(</span>
<span class="sd">...     sample_rate=16000, win_length=25, hop_length=10, n_fft=400</span>
<span class="sd">... )</span>
<span class="sd">&gt;&gt;&gt; features = compute_STFT(signal)</span>
<span class="sd">&gt;&gt;&gt; features = spectral_magnitude(features)</span>
<span class="sd">&gt;&gt;&gt; compute_fbanks = Filterbank(n_mels=40)</span>
<span class="sd">&gt;&gt;&gt; features = compute_fbanks(features)</span>
<span class="sd">&gt;&gt;&gt; compute_mfccs = DCT(input_size=40, n_out=20)</span>
<span class="sd">&gt;&gt;&gt; features = compute_mfccs(features)</span>
<span class="sd">&gt;&gt;&gt; compute_deltas = Deltas(input_size=20)</span>
<span class="sd">&gt;&gt;&gt; delta1 = compute_deltas(features)</span>
<span class="sd">&gt;&gt;&gt; delta2 = compute_deltas(delta1)</span>
<span class="sd">&gt;&gt;&gt; features = torch.cat([features, delta1, delta2], dim=2)</span>
<span class="sd">&gt;&gt;&gt; compute_cw = ContextWindow(left_frames=5, right_frames=5)</span>
<span class="sd">&gt;&gt;&gt; features  = compute_cw(features)</span>
<span class="sd">&gt;&gt;&gt; norm = InputNormalization()</span>
<span class="sd">&gt;&gt;&gt; features = norm(features, torch.tensor([1]).float())</span>

<span class="sd">Authors</span>
<span class="sd"> * Mirco Ravanelli 2020</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">packaging</span> <span class="k">import</span> <span class="n">version</span>
<span class="kn">from</span> <span class="nn">speechbrain.utils.checkpoints</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">mark_as_saver</span><span class="p">,</span>
    <span class="n">mark_as_loader</span><span class="p">,</span>
    <span class="n">register_checkpoint_hooks</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="STFT"><a class="viewcode-back" href="../../../speechbrain.processing.features.html#speechbrain.processing.features.STFT">[docs]</a><span class="k">class</span> <span class="nc">STFT</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;computes the Short-Term Fourier Transform (STFT).</span>

<span class="sd">    This class computes the Short-Term Fourier Transform of an audio signal.</span>
<span class="sd">    It supports multi-channel audio inputs (batch, time, channels).</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    sample_rate : int</span>
<span class="sd">        Sample rate of the input audio signal (e.g 16000).</span>
<span class="sd">    win_length : float</span>
<span class="sd">        Length (in ms) of the sliding window used to compute the STFT.</span>
<span class="sd">    hop_length : float</span>
<span class="sd">        Length (in ms) of the hope of the sliding window used to compute</span>
<span class="sd">        the STFT.</span>
<span class="sd">    n_fft : int</span>
<span class="sd">        Number of fft point of the STFT. It defines the frequency resolution</span>
<span class="sd">        (n_fft should be &lt;= than win_len).</span>
<span class="sd">    window_fn : function</span>
<span class="sd">        A function that takes an integer (number of samples) and outputs a</span>
<span class="sd">        tensor to be multiplied with each window before fft.</span>
<span class="sd">    normalized_stft : bool</span>
<span class="sd">        If True, the function returns the  normalized STFT results,</span>
<span class="sd">        i.e., multiplied by win_length^-0.5 (default is False).</span>
<span class="sd">    center : bool</span>
<span class="sd">        If True (default), the input will be padded on both sides so that the</span>
<span class="sd">        t-th frame is centered at time t×hop_length. Otherwise, the t-th frame</span>
<span class="sd">        begins at time t×hop_length.</span>
<span class="sd">    pad_mode : str</span>
<span class="sd">        It can be &#39;constant&#39;,&#39;reflect&#39;,&#39;replicate&#39;, &#39;circular&#39;, &#39;reflect&#39;</span>
<span class="sd">        (default). &#39;constant&#39; pads the input tensor boundaries with a</span>
<span class="sd">        constant value. &#39;reflect&#39; pads the input tensor using the reflection</span>
<span class="sd">        of the input boundary. &#39;replicate&#39; pads the input tensor using</span>
<span class="sd">        replication of the input boundary. &#39;circular&#39; pads using  circular</span>
<span class="sd">        replication.</span>
<span class="sd">    onesided : True</span>
<span class="sd">        If True (default) only returns nfft/2 values. Note that the other</span>
<span class="sd">        samples are redundant due to the Fourier transform conjugate symmetry.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; import torch</span>
<span class="sd">    &gt;&gt;&gt; compute_STFT = STFT(</span>
<span class="sd">    ...     sample_rate=16000, win_length=25, hop_length=10, n_fft=400</span>
<span class="sd">    ... )</span>
<span class="sd">    &gt;&gt;&gt; inputs = torch.randn([10, 16000])</span>
<span class="sd">    &gt;&gt;&gt; features = compute_STFT(inputs)</span>
<span class="sd">    &gt;&gt;&gt; features.shape</span>
<span class="sd">    torch.Size([10, 101, 201, 2])</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sample_rate</span><span class="p">,</span>
        <span class="n">win_length</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
        <span class="n">hop_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">n_fft</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
        <span class="n">window_fn</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">hamming_window</span><span class="p">,</span>
        <span class="n">normalized_stft</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">pad_mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span>
        <span class="n">onesided</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span> <span class="o">=</span> <span class="n">sample_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">win_length</span> <span class="o">=</span> <span class="n">win_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hop_length</span> <span class="o">=</span> <span class="n">hop_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_fft</span> <span class="o">=</span> <span class="n">n_fft</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalized_stft</span> <span class="o">=</span> <span class="n">normalized_stft</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">center</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pad_mode</span> <span class="o">=</span> <span class="n">pad_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onesided</span> <span class="o">=</span> <span class="n">onesided</span>

        <span class="c1"># Convert win_length and hop_length from ms to samples</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">win_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="nb">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">win_length</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hop_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="nb">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">hop_length</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="o">=</span> <span class="n">window_fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">win_length</span><span class="p">)</span>

<div class="viewcode-block" id="STFT.forward"><a class="viewcode-back" href="../../../speechbrain.processing.features.html#speechbrain.processing.features.STFT.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the STFT generated from the input waveforms.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        x : tensor</span>
<span class="sd">            A batch of audio signals to transform.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Managing multi-channel stft</span>
        <span class="n">or_shape</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">or_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">or_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">or_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">or_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;1.6.0&quot;</span><span class="p">):</span>
            <span class="n">stft</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stft</span><span class="p">(</span>
                <span class="n">x</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_fft</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hop_length</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">win_length</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pad_mode</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">normalized_stft</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">onesided</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stft</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stft</span><span class="p">(</span>
                <span class="n">x</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_fft</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hop_length</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">win_length</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pad_mode</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">normalized_stft</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">onesided</span><span class="p">,</span>
                <span class="n">return_complex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Retrieving the original dimensionality (batch,time, channels)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">or_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">stft</span> <span class="o">=</span> <span class="n">stft</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="n">or_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">or_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">stft</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">stft</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">stft</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">stft</span> <span class="o">=</span> <span class="n">stft</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># (batch, time, channels)</span>
            <span class="n">stft</span> <span class="o">=</span> <span class="n">stft</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">stft</span></div></div>


<div class="viewcode-block" id="ISTFT"><a class="viewcode-back" href="../../../speechbrain.processing.features.html#speechbrain.processing.features.ISTFT">[docs]</a><span class="k">class</span> <span class="nc">ISTFT</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Computes the Inverse Short-Term Fourier Transform (ISTFT)</span>

<span class="sd">    This class computes the Inverse Short-Term Fourier Transform of</span>
<span class="sd">    an audio signal. It supports multi-channel audio inputs</span>
<span class="sd">    (batch, time_step, n_fft, 2, n_channels [optional]).</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    sample_rate : int</span>
<span class="sd">        Sample rate of the input audio signal (e.g. 16000).</span>
<span class="sd">    win_length : float</span>
<span class="sd">        Length (in ms) of the sliding window used when computing the STFT.</span>
<span class="sd">    hop_length : float</span>
<span class="sd">        Length (in ms) of the hope of the sliding window used when computing</span>
<span class="sd">        the STFT.</span>
<span class="sd">    window_fn : function</span>
<span class="sd">        A function that takes an integer (number of samples) and outputs a</span>
<span class="sd">        tensor to be used as a window for ifft.</span>
<span class="sd">    normalized_stft : bool</span>
<span class="sd">        If True, the function assumes that it&#39;s working with the normalized</span>
<span class="sd">        STFT results. (default is False)</span>
<span class="sd">    center : bool</span>
<span class="sd">        If True (default), the function assumes that the STFT result was padded</span>
<span class="sd">        on both sides.</span>
<span class="sd">    onesided : True</span>
<span class="sd">        If True (default), the function assumes that there are n_fft/2 values</span>
<span class="sd">        for each time frame of the STFT.</span>
<span class="sd">    epsilon : float</span>
<span class="sd">        A small value to avoid division by 0 when normalizing by the sum of the</span>
<span class="sd">        squared window. Playing with it can fix some abnormalities at the</span>
<span class="sd">        beginning and at the end of the reconstructed signal. The default value</span>
<span class="sd">        of epsilon is 1e-12.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; import torch</span>
<span class="sd">    &gt;&gt;&gt; compute_STFT = STFT(</span>
<span class="sd">    ...     sample_rate=16000, win_length=25, hop_length=10, n_fft=400</span>
<span class="sd">    ... )</span>
<span class="sd">    &gt;&gt;&gt; compute_ISTFT = ISTFT(</span>
<span class="sd">    ...     sample_rate=16000, win_length=25, hop_length=10</span>
<span class="sd">    ... )</span>
<span class="sd">    &gt;&gt;&gt; inputs = torch.randn([10, 16000])</span>
<span class="sd">    &gt;&gt;&gt; outputs = compute_ISTFT(compute_STFT(inputs))</span>
<span class="sd">    &gt;&gt;&gt; outputs.shape</span>
<span class="sd">    torch.Size([10, 16000])</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sample_rate</span><span class="p">,</span>
        <span class="n">n_fft</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">win_length</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
        <span class="n">hop_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">window_fn</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">hamming_window</span><span class="p">,</span>
        <span class="n">normalized_stft</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">onesided</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">epsilon</span><span class="o">=</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span> <span class="o">=</span> <span class="n">sample_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_fft</span> <span class="o">=</span> <span class="n">n_fft</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">win_length</span> <span class="o">=</span> <span class="n">win_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hop_length</span> <span class="o">=</span> <span class="n">hop_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalized_stft</span> <span class="o">=</span> <span class="n">normalized_stft</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">center</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onesided</span> <span class="o">=</span> <span class="n">onesided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="n">epsilon</span>

        <span class="c1"># Convert win_length and hop_length from ms to samples</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">win_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="nb">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">win_length</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hop_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="nb">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">hop_length</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Create window using provided function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="o">=</span> <span class="n">window_fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">win_length</span><span class="p">)</span>

<div class="viewcode-block" id="ISTFT.forward"><a class="viewcode-back" href="../../../speechbrain.processing.features.html#speechbrain.processing.features.ISTFT.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">sig_length</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the ISTFT generated from the input signal.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        x : tensor</span>
<span class="sd">            A batch of audio signals in the frequency domain to transform.</span>
<span class="sd">        sig_length : int</span>
<span class="sd">            The length of the output signal in number of samples. If not</span>
<span class="sd">            specified will be equal to: (time_step - 1) * hop_length + n_fft</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">or_shape</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># Infer n_fft if not provided</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_fft</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">onesided</span><span class="p">:</span>
            <span class="n">n_fft</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_fft</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">onesided</span><span class="p">:</span>
            <span class="n">n_fft</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_fft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_fft</span>

        <span class="c1"># Changing the format for (batch, time_step, n_fft, 2, n_channels)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">or_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

            <span class="c1"># Lumping batch and channel dimension, because torch.istft</span>
            <span class="c1"># doesn&#39;t support batching.</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">or_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">istft</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">istft</span><span class="p">(</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
            <span class="n">n_fft</span><span class="o">=</span><span class="n">n_fft</span><span class="p">,</span>
            <span class="n">hop_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hop_length</span><span class="p">,</span>
            <span class="n">win_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">win_length</span><span class="p">,</span>
            <span class="n">window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
            <span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">,</span>
            <span class="n">onesided</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">onesided</span><span class="p">,</span>
            <span class="n">length</span><span class="o">=</span><span class="n">sig_length</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Convert back to (time, time_step, n_channels)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">or_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">istft</span> <span class="o">=</span> <span class="n">istft</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">or_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">or_shape</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">istft</span> <span class="o">=</span> <span class="n">istft</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">istft</span></div></div>


<div class="viewcode-block" id="spectral_magnitude"><a class="viewcode-back" href="../../../speechbrain.processing.features.html#speechbrain.processing.features.spectral_magnitude">[docs]</a><span class="k">def</span> <span class="nf">spectral_magnitude</span><span class="p">(</span><span class="n">stft</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">14</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the magnitude of a complex spectrogram.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    stft : torch.Tensor</span>
<span class="sd">        A tensor, output from the stft function.</span>
<span class="sd">    power : int</span>
<span class="sd">        What power to use in computing the magnitude.</span>
<span class="sd">        Use power=1 for the power spectrogram.</span>
<span class="sd">        Use power=0.5 for the magnitude spectrogram.</span>
<span class="sd">    log : bool</span>
<span class="sd">        Whether to apply log to the spectral features.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; a = torch.Tensor([[3, 4]])</span>
<span class="sd">    &gt;&gt;&gt; spectral_magnitude(a, power=0.5)</span>
<span class="sd">    tensor([5.])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spectr</span> <span class="o">=</span> <span class="n">stft</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Add eps avoids NaN when spectr is zero</span>
    <span class="k">if</span> <span class="n">power</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">spectr</span> <span class="o">=</span> <span class="n">spectr</span> <span class="o">+</span> <span class="n">eps</span>
    <span class="n">spectr</span> <span class="o">=</span> <span class="n">spectr</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">power</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">spectr</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">spectr</span></div>


<div class="viewcode-block" id="Filterbank"><a class="viewcode-back" href="../../../speechbrain.processing.features.html#speechbrain.processing.features.Filterbank">[docs]</a><span class="k">class</span> <span class="nc">Filterbank</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;computes filter bank (FBANK) features given spectral magnitudes.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    n_mels : float</span>
<span class="sd">        Number of Mel filters used to average the spectrogram.</span>
<span class="sd">    log_mel : bool</span>
<span class="sd">        If True, it computes the log of the FBANKs.</span>
<span class="sd">    filter_shape : str</span>
<span class="sd">        Shape of the filters (&#39;triangular&#39;, &#39;rectangular&#39;, &#39;gaussian&#39;).</span>
<span class="sd">    f_min : int</span>
<span class="sd">        Lowest frequency for the Mel filters.</span>
<span class="sd">    f_max : int</span>
<span class="sd">        Highest frequency for the Mel filters.</span>
<span class="sd">    n_fft : int</span>
<span class="sd">        Number of fft points of the STFT. It defines the frequency resolution</span>
<span class="sd">        (n_fft should be&lt;= than win_len).</span>
<span class="sd">    sample_rate : int</span>
<span class="sd">        Sample rate of the input audio signal (e.g, 16000)</span>
<span class="sd">    power_spectrogram : float</span>
<span class="sd">        Exponent used for spectrogram computation.</span>
<span class="sd">    amin : float</span>
<span class="sd">        Minimum amplitude (used for numerical stability).</span>
<span class="sd">    ref_value : float</span>
<span class="sd">        Reference value used for the dB scale.</span>
<span class="sd">    top_db : float</span>
<span class="sd">        Top dB valu used for log-mels.</span>
<span class="sd">    freeze : bool</span>
<span class="sd">        If False, it the central frequency and the band of each filter are</span>
<span class="sd">        added into nn.parameters. If True, the standard frozen features</span>
<span class="sd">        are computed.</span>
<span class="sd">    param_change_factor: bool</span>
<span class="sd">        If freeze=False, this parameter affects the speed at which the filter</span>
<span class="sd">        parameters (i.e., central_freqs and bands) can be changed.  When high</span>
<span class="sd">        (e.g., param_change_factor=1) the filters change a lot during training.</span>
<span class="sd">        When low (e.g. param_change_factor=0.1) the filter parameters are more</span>
<span class="sd">        stable during training</span>
<span class="sd">    param_rand_factor: float</span>
<span class="sd">        This parameter can be used to randomly change the filter parameters</span>
<span class="sd">        (i.e, central frequencies and bands) during training.  It is thus a</span>
<span class="sd">        sort of regularization. param_rand_factor=0 does not affect, while</span>
<span class="sd">        param_rand_factor=0.15 allows random variations within +-15% of the</span>
<span class="sd">        standard values of the filter parameters (e.g., if the central freq</span>
<span class="sd">        is 100 Hz, we can randomly change it from 85 Hz to 115 Hz).</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; import torch</span>
<span class="sd">    &gt;&gt;&gt; compute_fbanks = Filterbank()</span>
<span class="sd">    &gt;&gt;&gt; inputs = torch.randn([10, 101, 201])</span>
<span class="sd">    &gt;&gt;&gt; features = compute_fbanks(inputs)</span>
<span class="sd">    &gt;&gt;&gt; features.shape</span>
<span class="sd">    torch.Size([10, 101, 40])</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">n_mels</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
        <span class="n">log_mel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">filter_shape</span><span class="o">=</span><span class="s2">&quot;triangular&quot;</span><span class="p">,</span>
        <span class="n">f_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">f_max</span><span class="o">=</span><span class="mi">8000</span><span class="p">,</span>
        <span class="n">n_fft</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
        <span class="n">sample_rate</span><span class="o">=</span><span class="mi">16000</span><span class="p">,</span>
        <span class="n">power_spectrogram</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">amin</span><span class="o">=</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">ref_value</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">top_db</span><span class="o">=</span><span class="mf">80.0</span><span class="p">,</span>
        <span class="n">param_change_factor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">param_rand_factor</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">freeze</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_mels</span> <span class="o">=</span> <span class="n">n_mels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_mel</span> <span class="o">=</span> <span class="n">log_mel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter_shape</span> <span class="o">=</span> <span class="n">filter_shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_min</span> <span class="o">=</span> <span class="n">f_min</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_max</span> <span class="o">=</span> <span class="n">f_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_fft</span> <span class="o">=</span> <span class="n">n_fft</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span> <span class="o">=</span> <span class="n">sample_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">power_spectrogram</span> <span class="o">=</span> <span class="n">power_spectrogram</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">amin</span> <span class="o">=</span> <span class="n">amin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_value</span> <span class="o">=</span> <span class="n">ref_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top_db</span> <span class="o">=</span> <span class="n">top_db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freeze</span> <span class="o">=</span> <span class="n">freeze</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_stft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_fft</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_multiplier</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_value</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device_inp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_change_factor</span> <span class="o">=</span> <span class="n">param_change_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_rand_factor</span> <span class="o">=</span> <span class="n">param_rand_factor</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_spectrogram</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span> <span class="o">=</span> <span class="mi">20</span>

        <span class="c1"># Make sure f_min &lt; f_max</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_min</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_max</span><span class="p">:</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;Require f_min: </span><span class="si">%f</span><span class="s2"> &lt; f_max: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">f_min</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">f_max</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err_msg</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Filter definition</span>
        <span class="n">mel</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_to_mel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_min</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_mel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_max</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_mels</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="p">)</span>
        <span class="n">hz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_hz</span><span class="p">(</span><span class="n">mel</span><span class="p">)</span>

        <span class="c1"># Computation of the filter bands</span>
        <span class="n">band</span> <span class="o">=</span> <span class="n">hz</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">hz</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">band</span> <span class="o">=</span> <span class="n">band</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_central</span> <span class="o">=</span> <span class="n">hz</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Adding the central frequency and the band to the list of nn param</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">freeze</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f_central</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">f_central</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_change_factor</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">band</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">band</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_change_factor</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Frequency axis</span>
        <span class="n">all_freqs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_stft</span><span class="p">)</span>

        <span class="c1"># Replicating for all the filters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_freqs_mat</span> <span class="o">=</span> <span class="n">all_freqs</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_central</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="Filterbank.forward"><a class="viewcode-back" href="../../../speechbrain.processing.features.html#speechbrain.processing.features.Filterbank.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectrogram</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the FBANks.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        x : tensor</span>
<span class="sd">            A batch of spectrogram tensors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Computing central frequency and bandwidth of each filter</span>
        <span class="n">f_central_mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_central</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_freqs_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span>
        <span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">band_mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_freqs_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
        <span class="p">)</span>

        <span class="c1"># Uncomment to print filter parameters</span>
        <span class="c1"># print(self.f_central*self.sample_rate * self.param_change_factor)</span>
        <span class="c1"># print(self.band*self.sample_rate* self.param_change_factor)</span>

        <span class="c1"># Creation of the multiplication matrix. It is used to create</span>
        <span class="c1"># the filters that average the computed spectrogram.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">freeze</span><span class="p">:</span>
            <span class="n">f_central_mat</span> <span class="o">=</span> <span class="n">f_central_mat</span> <span class="o">*</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_change_factor</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_change_factor</span>
            <span class="p">)</span>
            <span class="n">band_mat</span> <span class="o">=</span> <span class="n">band_mat</span> <span class="o">*</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_change_factor</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_change_factor</span>
            <span class="p">)</span>

        <span class="c1"># Regularization with random changes of filter central frequnecy and band</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_rand_factor</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
            <span class="n">rand_change</span> <span class="o">=</span> <span class="p">(</span>
                <span class="mf">1.0</span>
                <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_rand_factor</span>
                <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_rand_factor</span>
            <span class="p">)</span>
            <span class="n">f_central_mat</span> <span class="o">=</span> <span class="n">f_central_mat</span> <span class="o">*</span> <span class="n">rand_change</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">band_mat</span> <span class="o">=</span> <span class="n">band_mat</span> <span class="o">*</span> <span class="n">rand_change</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">fbank_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_fbank_matrix</span><span class="p">(</span><span class="n">f_central_mat</span><span class="p">,</span> <span class="n">band_mat</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
            <span class="n">spectrogram</span><span class="o">.</span><span class="n">device</span>
        <span class="p">)</span>

        <span class="n">sp_shape</span> <span class="o">=</span> <span class="n">spectrogram</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># Managing multi-channels case (batch, time, channels)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sp_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">spectrogram</span> <span class="o">=</span> <span class="n">spectrogram</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="n">sp_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">sp_shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">sp_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sp_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="c1"># FBANK computation</span>
        <span class="n">fbanks</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">spectrogram</span><span class="p">,</span> <span class="n">fbank_matrix</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_mel</span><span class="p">:</span>
            <span class="n">fbanks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_amplitude_to_DB</span><span class="p">(</span><span class="n">fbanks</span><span class="p">)</span>

        <span class="c1"># Reshaping in the case of multi-channel inputs</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sp_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">fb_shape</span> <span class="o">=</span> <span class="n">fbanks</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">fbanks</span> <span class="o">=</span> <span class="n">fbanks</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="n">sp_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fb_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fb_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">sp_shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">fbanks</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_to_mel</span><span class="p">(</span><span class="n">hz</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns mel-frequency value corresponding to the input</span>
<span class="sd">        frequency value in Hz.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        x : float</span>
<span class="sd">            The frequency point in Hz.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">2595</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">hz</span> <span class="o">/</span> <span class="mi">700</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_to_hz</span><span class="p">(</span><span class="n">mel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns hz-frequency value corresponding to the input</span>
<span class="sd">        mel-frequency value.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        x : float</span>
<span class="sd">            The frequency point in the mel-scale.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">700</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="n">mel</span> <span class="o">/</span> <span class="mi">2595</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_triangular_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">all_freqs</span><span class="p">,</span> <span class="n">f_central</span><span class="p">,</span> <span class="n">band</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns fbank matrix using triangular filters.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        all_freqs : Tensor</span>
<span class="sd">            Tensor gathering all the frequency points.</span>
<span class="sd">        f_central : Tensor</span>
<span class="sd">            Tensor gathering central frequencies of each filter.</span>
<span class="sd">        band : Tensor</span>
<span class="sd">            Tensor gathering the bands of each filter.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Computing the slops of the filters</span>
        <span class="n">slope</span> <span class="o">=</span> <span class="p">(</span><span class="n">all_freqs</span> <span class="o">-</span> <span class="n">f_central</span><span class="p">)</span> <span class="o">/</span> <span class="n">band</span>
        <span class="n">left_side</span> <span class="o">=</span> <span class="n">slope</span> <span class="o">+</span> <span class="mf">1.0</span>
        <span class="n">right_side</span> <span class="o">=</span> <span class="o">-</span><span class="n">slope</span> <span class="o">+</span> <span class="mf">1.0</span>

        <span class="c1"># Adding zeros for negative values</span>
        <span class="n">zero</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device_inp</span><span class="p">)</span>
        <span class="n">fbank_matrix</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
            <span class="n">zero</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">left_side</span><span class="p">,</span> <span class="n">right_side</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fbank_matrix</span>

    <span class="k">def</span> <span class="nf">_rectangular_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">all_freqs</span><span class="p">,</span> <span class="n">f_central</span><span class="p">,</span> <span class="n">band</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns fbank matrix using rectangular filters.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        all_freqs : Tensor</span>
<span class="sd">            Tensor gathering all the frequency points.</span>
<span class="sd">        f_central : Tensor</span>
<span class="sd">            Tensor gathering central frequencies of each filter.</span>
<span class="sd">        band : Tensor</span>
<span class="sd">            Tensor gathering the bands of each filter.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># cut-off frequencies of the filters</span>
        <span class="n">low_hz</span> <span class="o">=</span> <span class="n">f_central</span> <span class="o">-</span> <span class="n">band</span>
        <span class="n">high_hz</span> <span class="o">=</span> <span class="n">f_central</span> <span class="o">+</span> <span class="n">band</span>

        <span class="c1"># Left/right parts of the filter</span>
        <span class="n">left_side</span> <span class="o">=</span> <span class="n">right_size</span> <span class="o">=</span> <span class="n">all_freqs</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="n">low_hz</span><span class="p">)</span>
        <span class="n">right_size</span> <span class="o">=</span> <span class="n">all_freqs</span><span class="o">.</span><span class="n">le</span><span class="p">(</span><span class="n">high_hz</span><span class="p">)</span>

        <span class="n">fbank_matrix</span> <span class="o">=</span> <span class="p">(</span><span class="n">left_side</span> <span class="o">*</span> <span class="n">right_size</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fbank_matrix</span>

    <span class="k">def</span> <span class="nf">_gaussian_filters</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">all_freqs</span><span class="p">,</span> <span class="n">f_central</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">smooth_factor</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns fbank matrix using gaussian filters.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        all_freqs : Tensor</span>
<span class="sd">            Tensor gathering all the frequency points.</span>
<span class="sd">        f_central : Tensor</span>
<span class="sd">            Tensor gathering central frequencies of each filter.</span>
<span class="sd">        band : Tensor</span>
<span class="sd">            Tensor gathering the bands of each filter.</span>
<span class="sd">        smooth_factor: Tensor</span>
<span class="sd">            Smoothing factor of the gaussian filter. It can be used to employ</span>
<span class="sd">            sharper or flatter filters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fbank_matrix</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
            <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">((</span><span class="n">all_freqs</span> <span class="o">-</span> <span class="n">f_central</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">band</span> <span class="o">/</span> <span class="n">smooth_factor</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fbank_matrix</span>

    <span class="k">def</span> <span class="nf">_create_fbank_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f_central_mat</span><span class="p">,</span> <span class="n">band_mat</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns fbank matrix to use for averaging the spectrum with</span>
<span class="sd">           the set of filter-banks.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        f_central : Tensor</span>
<span class="sd">            Tensor gathering central frequencies of each filter.</span>
<span class="sd">        band : Tensor</span>
<span class="sd">            Tensor gathering the bands of each filter.</span>
<span class="sd">        smooth_factor: Tensor</span>
<span class="sd">            Smoothing factor of the gaussian filter. It can be used to employ</span>
<span class="sd">            sharper or flatter filters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_shape</span> <span class="o">==</span> <span class="s2">&quot;triangular&quot;</span><span class="p">:</span>
            <span class="n">fbank_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_triangular_filters</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">all_freqs_mat</span><span class="p">,</span> <span class="n">f_central_mat</span><span class="p">,</span> <span class="n">band_mat</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_shape</span> <span class="o">==</span> <span class="s2">&quot;rectangular&quot;</span><span class="p">:</span>
            <span class="n">fbank_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rectangular_filters</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">all_freqs_mat</span><span class="p">,</span> <span class="n">f_central_mat</span><span class="p">,</span> <span class="n">band_mat</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">fbank_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gaussian_filters</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">all_freqs_mat</span><span class="p">,</span> <span class="n">f_central_mat</span><span class="p">,</span> <span class="n">band_mat</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">fbank_matrix</span>

    <span class="k">def</span> <span class="nf">_amplitude_to_DB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converts  linear-FBANKs to log-FBANKs.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        x : Tensor</span>
<span class="sd">            A batch of linear FBANK tensors.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">amin</span><span class="p">))</span>
        <span class="n">x_db</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_multiplier</span>

        <span class="c1"># Setting up dB max</span>
        <span class="n">new_x_db_max</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">x_db</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_db</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x_db</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Clipping to dB max</span>
        <span class="n">x_db</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x_db</span><span class="p">,</span> <span class="n">new_x_db_max</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x_db</span></div>


<div class="viewcode-block" id="DCT"><a class="viewcode-back" href="../../../speechbrain.processing.features.html#speechbrain.processing.features.DCT">[docs]</a><span class="k">class</span> <span class="nc">DCT</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes the discrete cosine transform.</span>

<span class="sd">    This class is primarily used to compute MFCC features of an audio signal</span>
<span class="sd">    given a set of FBANK features as input.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    input_size : int</span>
<span class="sd">        Expected size of the last dimension in the input.</span>
<span class="sd">    n_out : int</span>
<span class="sd">        Number of output coefficients.</span>
<span class="sd">    ortho_norm : bool</span>
<span class="sd">        Whether to use orthogonal norm.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; import torch</span>
<span class="sd">    &gt;&gt;&gt; inputs = torch.randn([10, 101, 40])</span>
<span class="sd">    &gt;&gt;&gt; compute_mfccs = DCT(input_size=inputs.size(-1))</span>
<span class="sd">    &gt;&gt;&gt; features = compute_mfccs(inputs)</span>
<span class="sd">    &gt;&gt;&gt; features.shape</span>
<span class="sd">    torch.Size([10, 101, 20])</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">input_size</span><span class="p">,</span> <span class="n">n_out</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">ortho_norm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">n_out</span> <span class="o">&gt;</span> <span class="n">input_size</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot select more DCT coefficients than inputs &quot;</span>
                <span class="s2">&quot;(n_out=</span><span class="si">%i</span><span class="s2">, n_in=</span><span class="si">%i</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n_out</span><span class="p">,</span> <span class="n">input_size</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Generate matix for DCT transformation</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">input_size</span><span class="p">))</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">n_out</span><span class="p">))</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dct</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">input_size</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">k</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ortho_norm</span><span class="p">:</span>
            <span class="n">dct</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
            <span class="n">dct</span> <span class="o">*=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">input_size</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dct</span> <span class="o">*=</span> <span class="mf">2.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dct_mat</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">t</span><span class="p">()</span>

<div class="viewcode-block" id="DCT.forward"><a class="viewcode-back" href="../../../speechbrain.processing.features.html#speechbrain.processing.features.DCT.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the DCT of the input tensor.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        x : tensor</span>
<span class="sd">            A batch of tensors to transform, usually fbank features.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Managing multi-channels case</span>
        <span class="n">input_shape</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># apply the DCT transform</span>
        <span class="n">dct</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dct_mat</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">))</span>

        <span class="c1"># Reshape in the case of multi-channels</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">dct</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="n">input_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dct</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dct</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">input_shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">dct</span></div></div>


<div class="viewcode-block" id="Deltas"><a class="viewcode-back" href="../../../speechbrain.processing.features.html#speechbrain.processing.features.Deltas">[docs]</a><span class="k">class</span> <span class="nc">Deltas</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes delta coefficients (time derivatives).</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    win_length : int</span>
<span class="sd">        Length of the window used to compute the time derivatives.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; inputs = torch.randn([10, 101, 20])</span>
<span class="sd">    &gt;&gt;&gt; compute_deltas = Deltas(input_size=inputs.size(-1))</span>
<span class="sd">    &gt;&gt;&gt; features = compute_deltas(inputs)</span>
<span class="sd">    &gt;&gt;&gt; features.shape</span>
<span class="sd">    torch.Size([10, 101, 20])</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">input_size</span><span class="p">,</span> <span class="n">window_length</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">window_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">denom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span>
            <span class="s2">&quot;kernel&quot;</span><span class="p">,</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
                <span class="n">input_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
            <span class="p">),</span>
        <span class="p">)</span>

<div class="viewcode-block" id="Deltas.forward"><a class="viewcode-back" href="../../../speechbrain.processing.features.html#speechbrain.processing.features.Deltas.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the delta coefficients.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        x : tensor</span>
<span class="sd">            A batch of tensors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Managing multi-channel deltas reshape tensor (batch*channel,time)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">or_shape</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">or_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">or_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">or_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">or_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">or_shape</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

        <span class="c1"># Padding for time borders</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;replicate&quot;</span><span class="p">)</span>

        <span class="c1"># Derivative estimation (with a fixed convolutional kernel)</span>
        <span class="n">delta_coeff</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">conv1d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">denom</span>
        <span class="p">)</span>

        <span class="c1"># Retrieving the original dimensionality (for multi-channel case)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">or_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">delta_coeff</span> <span class="o">=</span> <span class="n">delta_coeff</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="n">or_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">or_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">or_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">or_shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="n">delta_coeff</span> <span class="o">=</span> <span class="n">delta_coeff</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">delta_coeff</span></div></div>


<div class="viewcode-block" id="ContextWindow"><a class="viewcode-back" href="../../../speechbrain.processing.features.html#speechbrain.processing.features.ContextWindow">[docs]</a><span class="k">class</span> <span class="nc">ContextWindow</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes the context window.</span>

<span class="sd">    This class applies a context window by gathering multiple time steps</span>
<span class="sd">    in a single feature vector. The operation is performed with a</span>
<span class="sd">    convolutional layer based on a fixed kernel designed for that.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    left_frames : int</span>
<span class="sd">         Number of left frames (i.e, past frames) to collect.</span>
<span class="sd">    right_frames : int</span>
<span class="sd">        Number of right frames (i.e, future frames) to collect.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; import torch</span>
<span class="sd">    &gt;&gt;&gt; compute_cw = ContextWindow(left_frames=5, right_frames=5)</span>
<span class="sd">    &gt;&gt;&gt; inputs = torch.randn([10, 101, 20])</span>
<span class="sd">    &gt;&gt;&gt; features = compute_cw(inputs)</span>
<span class="sd">    &gt;&gt;&gt; features.shape</span>
<span class="sd">    torch.Size([10, 101, 220])</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">left_frames</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">right_frames</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">left_frames</span> <span class="o">=</span> <span class="n">left_frames</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">right_frames</span> <span class="o">=</span> <span class="n">right_frames</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">left_frames</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">right_frames</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel_len</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">left_frames</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">right_frames</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># Kernel definition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context_len</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_len</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">right_frames</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">left_frames</span><span class="p">:</span>
            <span class="n">lag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">right_frames</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">left_frames</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">,</span> <span class="n">lag</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">first_call</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="ContextWindow.forward"><a class="viewcode-back" href="../../../speechbrain.processing.features.html#speechbrain.processing.features.ContextWindow.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the tensor with the surrounding context.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        x : tensor</span>
<span class="sd">            A batch of tensors.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_call</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">first_call</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_len</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_len</span><span class="p">,)</span>
                <span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Managing multi-channel case</span>
        <span class="n">or_shape</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">or_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">or_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">or_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">or_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">or_shape</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

        <span class="c1"># Compute context (using the estimated convolutional kernel)</span>
        <span class="n">cw_x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">conv1d</span><span class="p">(</span>
            <span class="n">x</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
            <span class="n">groups</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">padding</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">left_frames</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">right_frames</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Retrieving the original dimensionality (for multi-channel case)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">or_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">cw_x</span> <span class="o">=</span> <span class="n">cw_x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="n">or_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cw_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">or_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">cw_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="n">cw_x</span> <span class="o">=</span> <span class="n">cw_x</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cw_x</span></div></div>


<div class="viewcode-block" id="InputNormalization"><a class="viewcode-back" href="../../../speechbrain.processing.features.html#speechbrain.processing.features.InputNormalization">[docs]</a><span class="nd">@register_checkpoint_hooks</span>
<span class="k">class</span> <span class="nc">InputNormalization</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Performs mean and variance normalization of the input tensor.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    mean_norm : True</span>
<span class="sd">         If True, the mean will be normalized.</span>
<span class="sd">    std_norm : True</span>
<span class="sd">         If True, the standard deviation will be normalized.</span>
<span class="sd">    norm_type : str</span>
<span class="sd">         It defines how the statistics are computed (&#39;sentence&#39; computes them</span>
<span class="sd">         at sentence level, &#39;batch&#39; at batch level, &#39;speaker&#39; at speaker</span>
<span class="sd">         level, while global computes a single normalization vector for all</span>
<span class="sd">         the sentences in the dataset). Speaker and global statistics are</span>
<span class="sd">         computed with a moving average approach.</span>
<span class="sd">    avg_factor : float</span>
<span class="sd">         It can be used to manually set the weighting factor between</span>
<span class="sd">         current statistics and accumulated ones.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; import torch</span>
<span class="sd">    &gt;&gt;&gt; norm = InputNormalization()</span>
<span class="sd">    &gt;&gt;&gt; inputs = torch.randn([10, 101, 20])</span>
<span class="sd">    &gt;&gt;&gt; inp_len = torch.ones([10])</span>
<span class="sd">    &gt;&gt;&gt; features = norm(inputs, inp_len)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Dict</span>

    <span class="n">spk_dict_mean</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>
    <span class="n">spk_dict_std</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>
    <span class="n">spk_dict_count</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mean_norm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">std_norm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">norm_type</span><span class="o">=</span><span class="s2">&quot;global&quot;</span><span class="p">,</span>
        <span class="n">avg_factor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">requires_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">update_until_epoch</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean_norm</span> <span class="o">=</span> <span class="n">mean_norm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">std_norm</span> <span class="o">=</span> <span class="n">std_norm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_type</span> <span class="o">=</span> <span class="n">norm_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avg_factor</span> <span class="o">=</span> <span class="n">avg_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="n">requires_grad</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">glob_mean</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">glob_std</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spk_dict_mean</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spk_dict_std</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spk_dict_count</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">=</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device_inp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_until_epoch</span> <span class="o">=</span> <span class="n">update_until_epoch</span>

<div class="viewcode-block" id="InputNormalization.forward"><a class="viewcode-back" href="../../../speechbrain.processing.features.html#speechbrain.processing.features.InputNormalization.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">lengths</span><span class="p">,</span> <span class="n">spk_ids</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([]),</span> <span class="n">epoch</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the tensor with the surrounding context.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        x : tensor</span>
<span class="sd">            A batch of tensors.</span>
<span class="sd">        lengths : tensor</span>
<span class="sd">            A batch of tensors containing the relative length of each</span>
<span class="sd">            sentence (e.g, [0.7, 0.9, 1.0]). It is used to avoid</span>
<span class="sd">            computing stats on zero-padded steps.</span>
<span class="sd">        spk_ids : tensor containing the ids of each speaker (e.g, [0 10 6]).</span>
<span class="sd">            It is used to perform per-speaker normalization when</span>
<span class="sd">            norm_type=&#39;speaker&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device_inp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">device</span>
        <span class="n">N_batches</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">current_means</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">current_stds</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">snt_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_batches</span><span class="p">):</span>

            <span class="c1"># Avoiding padded time steps</span>
            <span class="n">actual_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">lengths</span><span class="p">[</span><span class="n">snt_id</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

            <span class="c1"># computing statistics</span>
            <span class="n">current_mean</span><span class="p">,</span> <span class="n">current_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_current_stats</span><span class="p">(</span>
                <span class="n">x</span><span class="p">[</span><span class="n">snt_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">actual_size</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="n">current_means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_mean</span><span class="p">)</span>
            <span class="n">current_stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_std</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_type</span> <span class="o">==</span> <span class="s2">&quot;sentence&quot;</span><span class="p">:</span>

                <span class="n">x</span><span class="p">[</span><span class="n">snt_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">snt_id</span><span class="p">]</span> <span class="o">-</span> <span class="n">current_mean</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">/</span> <span class="n">current_std</span><span class="o">.</span><span class="n">data</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_type</span> <span class="o">==</span> <span class="s2">&quot;speaker&quot;</span><span class="p">:</span>

                <span class="n">spk_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">spk_ids</span><span class="p">[</span><span class="n">snt_id</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">spk_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spk_dict_mean</span><span class="p">:</span>

                    <span class="c1"># Initialization of the dictionary</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">spk_dict_mean</span><span class="p">[</span><span class="n">spk_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_mean</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">spk_dict_std</span><span class="p">[</span><span class="n">spk_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_std</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">spk_dict_count</span><span class="p">[</span><span class="n">spk_id</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">spk_dict_count</span><span class="p">[</span><span class="n">spk_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">spk_dict_count</span><span class="p">[</span><span class="n">spk_id</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">avg_factor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">spk_dict_count</span><span class="p">[</span><span class="n">spk_id</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avg_factor</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">spk_dict_mean</span><span class="p">[</span><span class="n">spk_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span>
                    <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">spk_dict_mean</span><span class="p">[</span><span class="n">spk_id</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">*</span> <span class="n">current_mean</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">spk_dict_std</span><span class="p">[</span><span class="n">spk_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span>
                    <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">spk_dict_std</span><span class="p">[</span><span class="n">spk_id</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">*</span> <span class="n">current_std</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">spk_dict_mean</span><span class="p">[</span><span class="n">spk_id</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">spk_dict_std</span><span class="p">[</span><span class="n">spk_id</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>

                <span class="n">x</span><span class="p">[</span><span class="n">snt_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">x</span><span class="p">[</span><span class="n">snt_id</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">spk_dict_mean</span><span class="p">[</span><span class="n">spk_id</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                <span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">spk_dict_std</span><span class="p">[</span><span class="n">spk_id</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_type</span> <span class="o">==</span> <span class="s2">&quot;batch&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_type</span> <span class="o">==</span> <span class="s2">&quot;global&quot;</span><span class="p">:</span>
            <span class="n">current_mean</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">current_means</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">current_std</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">current_stds</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_type</span> <span class="o">==</span> <span class="s2">&quot;batch&quot;</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">current_mean</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">current_std</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_type</span> <span class="o">==</span> <span class="s2">&quot;global&quot;</span><span class="p">:</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">glob_mean</span> <span class="o">=</span> <span class="n">current_mean</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">glob_std</span> <span class="o">=</span> <span class="n">current_std</span>

                <span class="k">elif</span> <span class="n">epoch</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_until_epoch</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">avg_factor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avg_factor</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">glob_mean</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span>
                    <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">glob_mean</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">*</span> <span class="n">current_mean</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">glob_std</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span>
                    <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">glob_std</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">*</span> <span class="n">current_std</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">glob_mean</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">glob_std</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>

                <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">glob_mean</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">glob_std</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">x</span></div>

    <span class="k">def</span> <span class="nf">_compute_current_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the tensor with the sourrounding context.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        x : tensor</span>
<span class="sd">            A batch of tensors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Compute current mean</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean_norm</span><span class="p">:</span>
            <span class="n">current_mean</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_mean</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="c1"># Compute current std</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">std_norm</span><span class="p">:</span>
            <span class="n">current_std</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_std</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">1.0</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="c1"># Improving numerical stability of std</span>
        <span class="n">current_std</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
            <span class="n">current_std</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">current_std</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">current_mean</span><span class="p">,</span> <span class="n">current_std</span>

    <span class="k">def</span> <span class="nf">_statistics_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fills the dictionary containing the normalization statistics.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">state</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;glob_mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">glob_mean</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;glob_std&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">glob_std</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;spk_dict_mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spk_dict_mean</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;spk_dict_std&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spk_dict_std</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;spk_dict_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spk_dict_count</span>

        <span class="k">return</span> <span class="n">state</span>

    <span class="k">def</span> <span class="nf">_load_statistics_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Loads the dictionary containing the statistics.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        state : dict</span>
<span class="sd">            A dictionary containing the normalization statistics.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;glob_mean&quot;</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">glob_mean</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;glob_mean&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">glob_std</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;glob_std&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">glob_mean</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;glob_mean&quot;</span><span class="p">]</span>  <span class="c1"># .to(self.device_inp)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">glob_std</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;glob_std&quot;</span><span class="p">]</span>  <span class="c1"># .to(self.device_inp)</span>

        <span class="c1"># Loading the spk_dict_mean in the right device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spk_dict_mean</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">spk</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;spk_dict_mean&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spk_dict_mean</span><span class="p">[</span><span class="n">spk</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;spk_dict_mean&quot;</span><span class="p">][</span><span class="n">spk</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">device_inp</span>
            <span class="p">)</span>

        <span class="c1"># Loading the spk_dict_std in the right device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spk_dict_std</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">spk</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;spk_dict_std&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spk_dict_std</span><span class="p">[</span><span class="n">spk</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;spk_dict_std&quot;</span><span class="p">][</span><span class="n">spk</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">device_inp</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">spk_dict_count</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;spk_dict_count&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">state</span>

    <span class="nd">@mark_as_saver</span>
    <span class="k">def</span> <span class="nf">_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save statistic dictionary.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        path : str</span>
<span class="sd">            A path where to save the dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_statistics_dict</span><span class="p">()</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

    <span class="nd">@mark_as_loader</span>
    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">end_of_epoch</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load statistic dictionary.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        path : str</span>
<span class="sd">            The path of the statistic dictionary</span>
<span class="sd">        end_of_epoch: bool</span>
<span class="sd">            If True, the training has completed a full epoch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="n">end_of_epoch</span>  <span class="c1"># Unused here.</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_statistics_dict</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021, SpeechBrain

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>